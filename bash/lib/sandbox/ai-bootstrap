# shellcheck shell=bash
# vim: ft=bash

source "$HOME/.config/lib/bash/prompt-patcher/lib.bash"

ensure_know_agent() {
    case "${1:-}" in
        claude|gemini|opencode) ;;
        *)
            echo "Unknown agent '${1:-}'" >&2
            exit 1
            ;;
    esac
}

patch_prompt_file() {
    local prompt_file="$1"
    local sandbox_name="${2:-}"

    local blocks=()
    [[ "${BACKEND:-}" == "container" ]] && blocks+=("sandbox-container")
    [[ "${BACKEND:-}" == "kvm" ]] && blocks+=("sandbox-vm")
    [[ "${BACKEND:-}" == "hcloud" ]] && blocks+=("sandbox-vm")
    [[ "${PROXY:-false}" == "true" ]] && blocks+=("proxy-restrictions")

    touch "$prompt_file"

    # Get allowlist path if proxy is enabled
    local allowlist_path=""
    if [[ "${PROXY:-false}" == "true" ]]; then
        allowlist_path="$(proxy_allowlist_path "$sandbox_name")"
    fi

    replace_all_prompt_blocks "$prompt_file" "$allowlist_path" "${blocks[@]}"
}

build_claude_config() {
    local tmp_target="$1/.claude"
    local sandbox_name="$2"
    local source="$HOME/.claude"
    mkdir -p "$tmp_target"

    local claude_optpl
    claude_optpl=$(optpl --show-alias claude)
    if [[ -f "$source/settings.json" ]]; then
        cp "$source/settings.json" "$tmp_target/"
    elif [[ -f "$claude_optpl" ]]; then
        optpl claude > "$tmp_target/settings.json"
    fi

    # Create minimal user config to skip initial setup dialog
    cat > "$1/.claude.json" <<'EOF'
{
  "theme": "dark",
  "hasCompletedOnboarding": true
}
EOF

    # I might copy in the original file if it exists but I don't have one.
    patch_prompt_file "$tmp_target/CLAUDE.md" "$sandbox_name"
}

build_gemini_config() {
    local tmp_target="$1/.gemini"
    local sandbox_name="$2"
    local source="$HOME/.gemini"
    mkdir -p "$tmp_target"

    cp "$source/.env" "$tmp_target"
    # feels a bit strange, no idea how a compromised token might be revoked.
    # maybe we'll just go through the setup again for now until I know how tokens can be revoked.
    #cp "$source/oauth_creds.json" "$tmp_target"

    patch_prompt_file "$tmp_target/GEMINI.md" "$sandbox_name"
}

build_opencode_config() {
    local tmp_target="$1/.config/opencode"
    local sandbox_name="$2"
    local source="$HOME/.config/opencode"
    mkdir -p "$tmp_target"

    local opencode_optpl
    opencode_optpl=$(optpl --show-alias opencode)
    if [[ -f "$source/opencode.jsonc" ]]; then
        cp "$source/opencode.jsonc" "$tmp_target/"
    elif [[ -f "$opencode_optpl" ]]; then
        optpl opencode > "$tmp_target/opencode.jsonc"
    fi

    patch_prompt_file "$tmp_target/AGENT.md" "$sandbox_name"
}

bootstrap_ai() {
    local name="$1"
    local agent="$2"

    local ssh_cmd
    local ssh_port
    local scp_args
    local scp_host
    declare -a ssh_cmd=(ssh)
    declare -a scp_args=()
    if is_ssh_alias_setup "$name"; then
        ssh_cmd+=("$name")
        scp_host="$name"
    elif ssh_port="$(backend_get_ssh_port "$name")"; then
        ssh_cmd+=(
            -o UserKnownHostsFile=/dev/null
            -o StrictHostKeyChecking=no
            -p "$ssh_port"
            dev@localhost
        )
        scp_args+=(
            -o UserKnownHostsFile=/dev/null
            -o StrictHostKeyChecking=no
            # it is a upper case P for scp
            -P "$ssh_port"
        )
        scp_host="dev@localhost"
    else
        echo "Could neither find a SSH alias nor a SSH port for sandbox $name" >&2
        exit 1
    fi

    local temp
    temp="$(mktemp -p /tmp -d bootstrap-ai-agent-XXXXXXXX)"
    # shellcheck disable=SC2064
    trap "rm -rf $temp" exit

    case "$agent" in
        claude)
            build_claude_config "$temp" "$name"
            npm_package="@anthropic-ai/claude-code"
            ;;
        gemini)
            build_gemini_config "$temp" "$name"
            npm_package="@google/gemini-cli"
            ;;
        opencode)
            build_opencode_config "$temp" "$name"
            npm_package="opencode-ai"
            ;;
        *)
            echo "Unknown agent '$agent'" >&2
            exit 1
            ;;
    esac

    echo "Uploading agent config"
    scp -r "$temp"/.* "$scp_host:~/"
    rm -rf "$temp"
    echo "Installing/Updating Agent..."

    local max_attempts=30
    local attempt=0
    local install_success=false

    while [[ $attempt -lt $max_attempts ]]; do
        attempt=$((attempt + 1))

        if "${ssh_cmd[@]}" "bash -c 'source ~/.config/setup/tools.sh && source ~/.config/setup/env.sh && npm -g install $npm_package'" 2>/dev/null; then
            install_success=true
            break
        fi

        if [[ $attempt -lt $max_attempts ]]; then
            echo "Installation attempt $attempt failed, retrying in 5 seconds..." >&2
            sleep 5
        fi
    done

    if [[ $install_success == false ]]; then
        echo "Failed to install agent after $max_attempts attempts" >&2
        exit 1
    fi
}
