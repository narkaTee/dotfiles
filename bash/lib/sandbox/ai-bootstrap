# shellcheck shell=bash
# vim: ft=bash

source "$HOME/.config/lib/bash/prompt-patcher/lib.bash"

AGENT_MAGIC_SKILLS="$HOME/.config/agent-magic/skills"

get_tool_skill_dir() {
    case "$1" in
        "claude") echo ".claude/skills" ;;
        "gemini") echo ".gemini/skills" ;;
        "opencode") echo ".agents/skills" ;;
        "codex") echo ".agents/skills" ;;
        "pi") return 1 ;;
        *)
            return 1
            ;;
    esac
}

ensure_know_agent() {
    case "${1:-}" in
        claude|gemini|opencode|codex|pi) ;;
        *)
            echo "Unknown agent '${1:-}'" >&2
            exit 1
            ;;
    esac
}

patch_prompt_file() {
    local prompt_file="$1"
    local sandbox_name="${2:-}"

    local blocks=()
    [[ "${BACKEND:-}" == "container" ]] && blocks+=("sandbox-container")
    [[ "${BACKEND:-}" == "kvm" ]] && blocks+=("sandbox-vm")
    [[ "${BACKEND:-}" == "hcloud" ]] && blocks+=("sandbox-vm")
    [[ "${PROXY:-false}" == "true" ]] && blocks+=("proxy-restrictions")

    touch "$prompt_file"

    # Get allowlist path if proxy is enabled
    local allowlist_path=""
    if [[ "${PROXY:-false}" == "true" ]]; then
        allowlist_path="$(proxy_allowlist_path "$sandbox_name")"
    fi

    replace_all_prompt_blocks "$prompt_file" "$allowlist_path" "${blocks[@]}"
}

build_claude_config() {
    local staging_dir="$1"
    local sandbox_name="$2"
    local source="$HOME/.claude"

    local selected_profile=""
    if hash cfg 2>/dev/null && cfg --has-profiles claude 2>/dev/null; then
        selected_profile=$(cfg --select claude 2>/dev/null) || {
            echo "cfg: Profile selection cancelled, aborting" >&2
            exit 1
        }
    fi

    if [[ -n "$selected_profile" ]]; then
        cfg "$selected_profile" --export-file --base-dir "$staging_dir" 2>/dev/null || true
    elif [[ -f "$source/settings.json" ]]; then
        mkdir -p "$staging_dir/.claude"
        cp "$source/settings.json" "$staging_dir/.claude/"
    fi

    mkdir -p "$staging_dir/.claude"

    local claude_json="$staging_dir/.claude.json"
    if [ ! -f "$claude_json" ] || ! jq -e '.hasCompletedOnboarding == true' "$claude_json" >/dev/null 2>&1; then
        if [ -f "$claude_json" ]; then
            jq '. + {hasCompletedOnboarding: true, theme: "dark"}' "$claude_json" > "${claude_json}.tmp" && mv "${claude_json}.tmp" "$claude_json"
        else
            cat > "$claude_json" <<'EOF'
{
  "theme": "dark",
  "hasCompletedOnboarding": true
}
EOF
        fi
    fi

    patch_prompt_file "$staging_dir/.claude/CLAUDE.md" "$sandbox_name"

    echo "$selected_profile" > "$staging_dir/.claude/.cfg_profile"
}

build_gemini_config() {
    local staging_dir="$1"
    local sandbox_name="$2"
    local source="$HOME/.gemini"

    local selected_profile=""
    if hash cfg 2>/dev/null && cfg --has-profiles gemini 2>/dev/null; then
        selected_profile=$(cfg --select gemini 2>/dev/null) || {
            echo "cfg: Profile selection cancelled, aborting" >&2
            exit 1
        }
    fi

    if [[ -n "$selected_profile" ]]; then
        cfg "$selected_profile" --export-file --base-dir "$staging_dir" 2>/dev/null || true
    elif [[ -f "$source/.env" ]]; then
        mkdir -p "$staging_dir/.gemini"
        cp "$source/.env" "$staging_dir/.gemini/"
    fi

    mkdir -p "$staging_dir/.gemini"
    patch_prompt_file "$staging_dir/.gemini/GEMINI.md" "$sandbox_name"

    echo "$selected_profile" > "$staging_dir/.gemini/.cfg_profile"
}

build_opencode_config() {
    local staging_dir="$1"
    local sandbox_name="$2"
    local source="$HOME/.config/opencode"

    local selected_profile=""
    if hash cfg 2>/dev/null && cfg --has-profiles opencode 2>/dev/null; then
        selected_profile=$(cfg --select opencode 2>/dev/null) || {
            echo "cfg: Profile selection cancelled, aborting" >&2
            exit 1
        }
    fi

    if [[ -n "$selected_profile" ]]; then
        cfg "$selected_profile" --export-file --base-dir "$staging_dir" 2>/dev/null || true
    elif [[ -f "$source/opencode.jsonc" ]]; then
        mkdir -p "$staging_dir/.config/opencode"
        cp "$source/opencode.jsonc" "$staging_dir/.config/opencode/"
    fi

    mkdir -p "$staging_dir/.config/opencode"
    patch_prompt_file "$staging_dir/.config/opencode/AGENT.md" "$sandbox_name"

    echo "$selected_profile" > "$staging_dir/.config/opencode/.cfg_profile"
}

build_codex_config() {
    local staging_dir="$1"
    local sandbox_name="$2"
    local source="$HOME/.codex"

    local selected_profile=""
    if hash cfg 2>/dev/null && cfg --has-profiles codex 2>/dev/null; then
        selected_profile=$(cfg --select codex 2>/dev/null) || {
            echo "cfg: Profile selection cancelled, aborting" >&2
            exit 1
        }
    fi

    if [[ -n "$selected_profile" ]]; then
        cfg "$selected_profile" --export-file --base-dir "$staging_dir" 2>/dev/null || true
    elif [[ -f "$source/config.toml" ]]; then
        mkdir -p "$staging_dir/.codex"
        cp "$source/config.toml" "$staging_dir/.codex/"
    fi

    mkdir -p "$staging_dir/.codex"
    patch_prompt_file "$staging_dir/.codex/AGENTS.md" "$sandbox_name"

    echo "$selected_profile" > "$staging_dir/.codex/.cfg_profile"
}

build_pi_config() {
    local staging_dir="$1"
    local sandbox_name="$2"

    local selected_profile=""
    if hash cfg 2>/dev/null && cfg --has-profiles pi 2>/dev/null; then
        selected_profile=$(cfg --select pi 2>/dev/null) || {
            echo "cfg: Profile selection cancelled, aborting" >&2
            exit 1
        }
    fi

    mkdir -p "$staging_dir/.pi/agent"
    patch_prompt_file "$staging_dir/.pi/agent/AGENTS.md" "$sandbox_name"

    echo "$selected_profile" > "$staging_dir/.pi/agent/.cfg_profile"
}

bootstrap_ai() {
    local name="$1"
    local agent="$2"

    local ssh_cmd
    local ssh_port
    local scp_args
    local scp_host
    declare -a ssh_cmd=(ssh)
    declare -a scp_args=()
    if is_ssh_alias_setup "$name"; then
        ssh_cmd+=("$name")
        scp_host="$name"
    elif ssh_port="$(backend_get_ssh_port "$name")"; then
        ssh_cmd+=(
            -o UserKnownHostsFile=/dev/null
            -o StrictHostKeyChecking=no
            -p "$ssh_port"
            dev@localhost
        )
        scp_args+=(
            -o UserKnownHostsFile=/dev/null
            -o StrictHostKeyChecking=no
            # it is a upper case P for scp
            -P "$ssh_port"
        )
        scp_host="dev@localhost"
    else
        echo "Could neither find a SSH alias nor a SSH port for sandbox $name" >&2
        exit 1
    fi

    local temp
    temp="$(mktemp -d "${XDG_RUNTIME_DIR:-/tmp}/ai-bootstrap.XXXXXX")"
    # shellcheck disable=SC2064
    trap "rm -rf $temp" exit

    local install_cmd
    case "$agent" in
        claude)
            build_claude_config "$temp" "$name"
            install_cmd="curl -fsSL https://claude.ai/install.sh | bash"
            ;;
        gemini)
            build_gemini_config "$temp" "$name"
            install_cmd="npm -g install @google/gemini-cli"
            ;;
        opencode)
            build_opencode_config "$temp" "$name"
            install_cmd="npm -g install opencode-ai"
            ;;
        codex)
            build_codex_config "$temp" "$name"
            install_cmd="npm -g install @openai/codex"
            ;;
        pi)
            build_pi_config "$temp" "$name"
            install_cmd="npm install -g @mariozechner/pi-coding-agent && pi install git:https://github.com/narkaTee/agent-magic"
            ;;
        *)
            echo "Unknown agent '$agent'" >&2
            exit 1
            ;;
    esac

    echo "Uploading agent config"
    scp "${scp_args[@]}" -r "$temp"/.* "$scp_host:~/"

    local tool_skill_dir
    if tool_skill_dir="$(get_tool_skill_dir "$agent")" && [[ -d "$AGENT_MAGIC_SKILLS" ]]; then
        echo "Uploading agent skills"
        "${ssh_cmd[@]}" "mkdir -p ~/$tool_skill_dir"
        scp "${scp_args[@]}" -r "$AGENT_MAGIC_SKILLS"/* "$scp_host:~/$tool_skill_dir/"
    fi

    if [[ -f "$temp/.claude/.cfg_profile" || -f "$temp/.gemini/.cfg_profile" || -f "$temp/.config/opencode/.cfg_profile" || -f "$temp/.codex/.cfg_profile" || -f "$temp/.pi/agent/.cfg_profile" ]]; then
        local profile_file
        for profile_file in "$temp"/*/.cfg_profile "$temp"/.config/*/.cfg_profile "$temp"/.pi/agent/.cfg_profile "$temp"/.codex/.cfg_profile; do
            if [[ -f "$profile_file" ]]; then
                local profile
                profile=$(<"$profile_file")
                if [[ -n "$profile" ]] && hash cfg 2>/dev/null; then
                    echo "Exporting environment variables from profile: $profile"
                    "${ssh_cmd[@]}" "bash -c 'cat >> ~/.config/setup/env.local.sh'" < <(cfg "$profile" --export-env 2>/dev/null || true)
                fi
            fi
        done
    fi

    rm -rf "$temp"
    echo "Installing/Updating Agent..."

    local max_attempts=6
    local attempt=0
    local install_success=false

    while [[ $attempt -lt $max_attempts ]]; do
        attempt=$((attempt + 1))

        if "${ssh_cmd[@]}" "bash -c 'source ~/.config/setup/tools.sh && source ~/.config/setup/env.sh && $install_cmd'" 2>/dev/null; then
            install_success=true
            break
        fi

        if [[ $attempt -lt $max_attempts ]]; then
            echo "Installation attempt $attempt failed, retrying in 5 seconds..." >&2
            sleep 5
        fi
    done

    if [[ $install_success == false ]]; then
        echo "Failed to install agent after $max_attempts attempts" >&2
        exit 1
    fi
}
