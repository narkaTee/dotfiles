#!/usr/bin/env bash
set -euo pipefail

source "$HOME/.config/lib/bash/sandbox/common"

BACKEND="container"
AI_BOOTSTRAP=""
# shellcheck disable=SC2034
PROXY=false
# shellcheck disable=SC2034
SYNC=false
# shellcheck disable=SC2034
HCLOUD_SELECT=false

validate_and_init_backend() {
    case "$BACKEND" in
        container)
            # the checks for the container engine are implicitly done when source-ing the backend
            ;;
        kvm)
            if [[ ! -e /dev/kvm ]]; then
                echo "Error: KVM not available (no /dev/kvm)" >&2
                exit 1
            fi
            if [[ ! -w /dev/kvm ]]; then
                echo "Error: KVM not writeable for this user" >&2
                exit 1
            fi
            if ! command -v qemu-system-x86_64 >/dev/null 2>&1; then
                echo "Error: qemu-system-x86_64 not found" >&2
                exit 1
            fi
            ;;
        hcloud)
            # Prerequisites validated in hcloud backend start function
            ;;
    esac

    source "$HOME/.config/lib/bash/sandbox/container-backend"
    source "$HOME/.config/lib/bash/sandbox/kvm-backend"
    source "$HOME/.config/lib/bash/sandbox/hcloud-backend"
    source "$HOME/.config/lib/bash/sandbox/proxy-backend"
    source "$HOME/.config/lib/bash/sandbox/proxy-cli"
}

sandbox_name() {
    local name
    name="sandbox-$(basename "$PWD")"
    echo "${name//[^a-zA-Z0-9_-]/_}"
}

ensure_sandbox() {
    local name="$1"
    if ! backend_is_running "$name"; then
        echo "No sandbox running for current directory" >&2
        exit 1
    fi
}

get_ssh_port_or_fail() {
    local name="$1"
    local port
    port="$(backend_get_ssh_port "$name")"
    if [[ -z "$port" ]]; then
        echo "Error: Could not determine SSH port" >&2
        exit 1
    fi
    echo "$port"
}

backend_is_running() {
    local name="$1"
    case "$BACKEND" in
        container) is_container_running "$name" ;;
        kvm) is_kvm_running "$name" ;;
        hcloud) is_hcloud_running "$name" ;;
    esac
}

backend_get_ssh_port() {
    local name="$1"
    case "$BACKEND" in
        container) get_container_ssh_port "$name" ;;
        kvm) get_kvm_ssh_port "$name" ;;
        hcloud) get_hcloud_ssh_port "$name" ;;
    esac
}

backend_get_ip() {
    local name="$1"
    local ip
    case "$BACKEND" in
        container) ip=$(get_container_ip "$name") ;;
        kvm) ip=$(get_kvm_ip "$name") ;;
        hcloud) ip=$(get_hcloud_ip "$name") ;;
    esac

    if [[ -z "$ip" ]]; then
        echo "Error: Could not determine IP address" >&2
        exit 1
    fi

    echo "$ip"
}

backend_start() {
    local name="$1"
    case "$BACKEND" in
        container) start_container_sandbox "$name" ;;
        kvm) start_kvm_sandbox "$name" ;;
        hcloud) start_hcloud_sandbox "$name" ;;
    esac
}

backend_stop() {
    local name="$1"
    case "$BACKEND" in
        container) stop_container_sandbox "$name" ;;
        kvm) stop_kvm_sandbox "$name" ;;
        hcloud) stop_hcloud_sandbox "$name" ;;
    esac
}

backend_enter() {
    local name="$1"
    case "$BACKEND" in
        container)
            exec $CONTAINER_ENGINE exec -it -e "TERM=${TERM:-xterm-256color}" -u dev -w /home/dev/workspace "$name" zsh
            ;;
        kvm)
            local port
            port="$(get_kvm_ssh_port "$name")"
            if [[ -z "$port" ]]; then
                echo "Error: Could not determine SSH port" >&2
                exit 1
            fi
            exec ssh -o UserKnownHostsFile=/dev/null \
                -o StrictHostKeyChecking=no \
                -p "$port" dev@localhost
            ;;
        hcloud)
            if is_ssh_alias_setup "$name"; then
                exec ssh "$name"
            else
                local state_dir
                state_dir="$(hcloud_state_dir "$name")"
                local ip_file="$state_dir/server.ip"
                if [[ -f "$ip_file" ]]; then
                    local server_ip
                    server_ip="$(cat "$ip_file")"
                    exec ssh -o UserKnownHostsFile=/dev/null \
                        -o StrictHostKeyChecking=no \
                        "dev@$server_ip"
                else
                    echo "Error: Could not determine server IP" >&2
                    exit 1
                fi
            fi
            ;;
    esac
}

detect_running_backend() {
    local sandbox_name
    sandbox_name="$(sandbox_name)"

    local container_running=false
    local kvm_running=false
    local hcloud_running=false

    if is_container_running "$sandbox_name"; then
        container_running=true
    fi

    if is_kvm_running "$sandbox_name"; then
        kvm_running=true
    fi

    if is_hcloud_running "$sandbox_name"; then
        hcloud_running=true
    fi

    local running_count=0
    $container_running && running_count=$((running_count + 1))
    $kvm_running && running_count=$((running_count + 1))
    $hcloud_running && running_count=$((running_count + 1))

    if [[ $running_count -gt 1 ]]; then
        echo "ERROR: Multiple backends running" >&2
        return 2
    elif $container_running; then
        echo "container"
        return 0
    elif $kvm_running; then
        echo "kvm"
        return 0
    elif $hcloud_running; then
        echo "hcloud"
        return 0
    else
        return 1
    fi
}

validate_no_backend_conflict() {
    local detected
    if detected=$(detect_running_backend); then
        if [[ "$detected" != "$BACKEND" ]]; then
            echo "Error: Already a running $detected sandbox" >&2
            exit 1
        fi
    fi
}

cmd_start_or_enter() {
    local name
    name="$(sandbox_name)"

    if [[ -n "${SANDBOX_CONTAINER:-}" ]]; then
        echo "Error: Already inside sandbox container" >&2
        exit 1
    fi

    if backend_is_running "$name"; then
        echo "Entering existing sandbox: $name ($BACKEND backend)"
    else
        validate_no_backend_conflict
        echo "Starting sandbox: $name ($BACKEND backend)"
        backend_start "$name"
    fi

    if [[ -n "$AI_BOOTSTRAP" ]]; then
        # Bootstrap each agent in comma-separated list
        IFS=',' read -ra agent_array <<< "$AI_BOOTSTRAP"
        for agent in "${agent_array[@]}"; do
            bootstrap_ai "$name" "$agent"
        done
    fi

    backend_enter "$name"
}

cmd_list() {
    echo "Running sandboxes (container backend):"
    list_container_sandboxes

    echo ""
    echo "Running sandboxes (kvm backend):"
    list_kvm_sandboxes

    echo ""
    echo "Running sandboxes (hcloud backend):"
    list_hcloud_sandboxes
}

cmd_stop() {
    local stop_all=false

    if [[ "${1:-}" == "-a" ]] || [[ "${1:-}" == "--all" ]]; then
        stop_all=true
    fi

    if $stop_all; then
        echo "Stopping all sandboxes (all backends)..."

        stop_all_container_sandboxes
        stop_all_kvm_sandboxes
        stop_all_hcloud_sandboxes
        remove_all_ssh_aliases

        echo "Done"
    else
        local name
        name="$(sandbox_name)"

        echo "Stopping sandbox: $name"
        if backend_is_running "$name"; then
            backend_stop "$name"
            remove_ssh_alias "$name"
        fi
        echo "Done"
    fi
}

cmd_info() {
    local name
    name="$(sandbox_name)"
    ensure_sandbox "$name"
    local port ip
    port="$(get_ssh_port_or_fail "$name")"
    ip="$(backend_get_ip "$name")"

    echo "Sandbox: $name"
    echo "Backend: $BACKEND"
    echo "Workspace: $PWD"

    if is_ssh_alias_setup "$name"; then
        echo ""
        echo "You can connect using the SSH alias:"
        echo "  ssh $name"
    else
        echo ""
        echo "SSH connection:"
        echo "  ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -p $port dev@$ip"
        echo ""
        echo "JetBrains Gateway:"
        echo "  Host: $ip"
        echo "  Port: $port"
        echo "  User: dev"
    fi

    if [[ "$BACKEND" == "kvm" ]]; then
        echo ""
        echo "Connect to vm console (to exit: ctrl+] or ctrl+altgr + 9 on qwertz keyboard):"
        echo "  socat STDIO,raw,echo=0,escape=0x1d UNIX-CONNECT:$(kvm_console_socket "$name")"
    fi
}

open_url() {
    local url="$1"

    if command -v open >/dev/null 2>&1; then
        open "$url" >/dev/null
    else
        echo "Error: open command found" >&2
        echo "Please open this URL manually:" >&2
        echo "$url" >&2
        exit 1
    fi
}

cmd_idea() {
    local name
    name="$(sandbox_name)"
    ensure_sandbox "$name"
    local port
    port="$(get_ssh_port_or_fail "$name")"

    # https://www.jetbrains.com/help/toolbox-app/gettings-started-with-ssh.html
    if is_ssh_alias_setup "$name"; then
        local url="jetbrains://gateway/ssh/environment?h=$name&launchIde=true&ideHint=IU&projectHint=/home/dev/workspace"
    else
        local url="jetbrains://gateway/ssh/environment?h=localhost&u=dev&p=${port}&launchIde=true&ideHint=IU&projectHint=/home/dev/workspace"
    fi

    echo "Opening IntelliJ IDEA on $name..."

    open_url "$url"
}

cmd_code() {
    local name
    name="$(sandbox_name)"
    ensure_sandbox "$name"
    local port
    port="$(get_ssh_port_or_fail "$name")"

    # https://code.visualstudio.com/docs/remote/troubleshooting#_connect-to-a-remote-host-from-the-terminal
    if is_ssh_alias_setup "$name"; then
        local remote="ssh-remote+${name}/home/dev/workspace"
    else
        local remote="ssh-remote+dev@localhost:${port}/home/dev/workspace"
    fi
    # https://code.visualstudio.com/docs/configure/command-line#_opening-vs-code-with-urls
    local url="vscode://vscode-remote/$remote"

    echo "Opening Visual Studio Code on $name..."

    if command -v code >/dev/null 2>&1; then
        code --folder-uri "vscode-remote://$remote"
    else
        open_url "$url"
    fi
}

cmd_tmux() {
    local name
    name="$(sandbox_name)"
    ensure_sandbox "$name"

    if ! command -v alacritty >/dev/null 2>&1; then
        echo "Error: Alacritty terminal emulator not found" >&2
        echo "Please install Alacritty to use 'sandbox tmux'" >&2
        exit 1
    fi

    echo "Opening Alacritty terminal with tmux session on $name..."

    # Terminal title follows the same pattern as auto_update_term_tittle in sh/setup/helper_functions.sh
    # Since we're connecting via SSH, the format is: dev@<hostname> (ssh)
    local title="dev@$name (ssh)"

    if is_ssh_alias_setup "$name"; then
        alacritty --title "$title" -e ssh -t "$name" "cd /home/dev/workspace && exec tmux new-session -A" &
    else
        local port ip
        port="$(get_ssh_port_or_fail "$name")"
        ip="$(backend_get_ip "$name")"
        alacritty --title "$title" -e ssh -t -o UserKnownHostsFile=/dev/null \
            -o StrictHostKeyChecking=no \
            -p "$port" "dev@$ip" \
            "cd /home/dev/workspace && exec tmux new-session -A" &
    fi
}

cmd_sync() {
    local direction="${1:-}"

    if [[ "$direction" != "up" ]] && [[ "$direction" != "down" ]]; then
        echo "Error: sync requires 'up' or 'down' argument" >&2
        echo "Usage: sandbox sync [up|down]" >&2
        exit 1
    fi

    # Check if backend is bind-mount based (container/KVM/proxy)
    if [[ "$BACKEND" == "container" ]] || [[ "$BACKEND" == "kvm" ]]; then
        echo "Error: sync command is only available for cloud backends (hcloud)" >&2
        echo "Container and KVM backends use bind mounts, so files are already synchronized" >&2
        exit 1
    fi

    local name
    name="$(sandbox_name)"
    ensure_sandbox "$name"

    # Get SSH connection info
    local ssh_target
    if is_ssh_alias_setup "$name"; then
        ssh_target="$name"
    else
        local ip
        ip="$(backend_get_ip "$name")"
        ssh_target="dev@$ip"
    fi

    # Perform rsync with mirror mode (destructive)
    if [[ "$direction" == "up" ]]; then
        echo "Uploading current directory to sandbox workspace..."
        rsync -hzav --no-o --no-g --delete \
            -e "ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" \
            ./ "${ssh_target}:/home/dev/workspace/"
    else
        echo "Downloading sandbox workspace to current directory..."
        rsync -hzav --no-o --no-g --delete \
            -e "ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" \
            "${ssh_target}:/home/dev/workspace/" ./
    fi

    echo "Sync complete"
}

cmd_help() {
    cat <<EOF
sandbox - Containerized development sandbox

Usage:
    sandbox [--kvm|--container|--hcloud] [flags] <command>

Global Flags:
    --kvm           Use KVM backend
                    Stronger Isolation, sudo and root access inside sandbox
                    BUT: without the proxy option the vm has access to all port open on the host...
    --container     Use container backend
                    Container Isolation, no root access
    --hcloud        Use Hetzner Cloud backend
                    Cloud-based VMs with ephemeral lifecycle (destroyed on stop)
                    Requires hcloud CLI and authentication
    --sync          Sync workspace to VM (hcloud backend only)
                    Runs rsync from current directory to /home/dev/workspace
    --select        Select Hetzner Cloud server type via fzf (hcloud backend only)
    --proxy          Force all communication to go throug a restrictive proxy
    --agents <list>  Bootstrap AI agents in the sandbox with credentials from the host
                     Accepts comma-separated list (e.g., claude,gemini)
                     Supported Agents: claude, gemini, opencode, codex, pi

Backend Selection:
    The backend is automatically detected based on running sandboxes.
    If no sandbox is running, defaults to container backend.
    Use --kvm, --container, or --hcloud to explicitly select a backend.

Commands:
    (none)        Start/enter sandbox for current directory
    idea          Open IntelliJ IDEA connected to sandbox
    code          Open Visual Studio Code connected to sandbox
    tmux          Open Alacritty terminal with tmux session
    proxy         Manage proxy and domain allowlist (see 'proxy help')
    sync up       Upload current directory to sandbox (cloud backends only)
    sync down     Download from sandbox to current directory (cloud backends only)
    list          List running sandboxes
    stop          Stop sandbox for current directory
    stop -a       Stop all sandboxes (all backends)
    info          Show SSH connection details
    help          Show this help

Examples:
    sandbox                   Start/enter (auto-detects backend)
    sandbox --kvm             Start KVM sandbox
    sandbox --hcloud          Start Hetzner Cloud sandbox
    sandbox --hcloud --select Start Hetzner Cloud sandbox with interactive server type selection
    sandbox --hcloud --sync   Start Hetzner Cloud sandbox with workspace sync
    sandbox code              Open VS Code (auto-detects backend)
    sandbox info              Show info (auto-detects backend)
    sandbox stop -a           Stop all sandboxes

Current backend: $BACKEND
EOF
}

main() {
    local non_option_args=()
    local backend_explicitly_set=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --kvm)
                BACKEND="kvm"
                backend_explicitly_set=true
                shift
                ;;
            --container)
                BACKEND="container"
                backend_explicitly_set=true
                shift
                ;;
            --hcloud)
                BACKEND="hcloud"
                backend_explicitly_set=true
                shift
                ;;
            --proxy)
                # shellcheck disable=SC2034
                PROXY=true
                shift
                ;;
            --sync)
                # shellcheck disable=SC2034
                SYNC=true
                shift
                ;;
            --select)
                # shellcheck disable=SC2034
                HCLOUD_SELECT=true
                shift
                ;;
            --agents)
                local agents="${2:-}"
                if [[ -z "$agents" ]]; then
                    echo "--agents parameter is missing the value"
                    exit 1
                fi
                source "$HOME/.config/lib/bash/sandbox/ai-bootstrap"
                # Validate all agent names
                IFS=',' read -ra agent_array <<< "$agents"
                for agent in "${agent_array[@]}"; do
                    ensure_know_agent "$agent"
                done
                AI_BOOTSTRAP="$agents"
                shift 2
                ;;
            *)
                non_option_args+=("$1")
                shift
                ;;
        esac
    done
    set -- "${non_option_args[@]}"

    validate_and_init_backend
    if ! $backend_explicitly_set; then
        local detected
        if detected=$(detect_running_backend); then
            BACKEND="$detected"
            validate_and_init_backend
        fi
    fi

    if [[ "${HCLOUD_SELECT:-false}" == "true" ]] && [[ "$BACKEND" != "hcloud" ]]; then
        echo "Error: --select is only available with --hcloud backend" >&2
        exit 1
    fi

    local cmd="${1:-}"

    case "$cmd" in
        ""|start|enter)  cmd_start_or_enter ;;
        idea)            cmd_idea ;;
        code)            cmd_code ;;
        tmux)            cmd_tmux ;;
        proxy)           shift; cmd_proxy "$@" ;;
        sync)            shift; cmd_sync "$@" ;;
        ls|list)         cmd_list ;;
        stop)            shift; cmd_stop "$@" ;;
        info)            cmd_info ;;
        help|--help|-h)  cmd_help ;;
        *)
            echo "Error: Unknown command: $cmd" >&2
            echo "" >&2
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
