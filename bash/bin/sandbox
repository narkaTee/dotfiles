#!/usr/bin/env bash
set -euo pipefail

SSH_CONFIG_DIR="$HOME/.ssh/config.d"
BACKEND="container"
AI_BOOTSTRAP=""
# shellcheck disable=SC2034
SANDBOX_CACHE_BASE="$HOME/.cache/sandbox"

validate_and_init_backend() {
    case "$BACKEND" in
        container)
            # the checks for the container engine are implicitly done when source-ing the backend
            ;;
        kvm)
            if [[ ! -e /dev/kvm ]]; then
                echo "Error: KVM not available (no /dev/kvm)" >&2
                exit 1
            fi
            if [[ ! -w /dev/kvm ]]; then
                echo "Error: KVM not writeable for this user" >&2
                exit 1
            fi
            if ! command -v qemu-system-x86_64 >/dev/null 2>&1; then
                echo "Error: qemu-system-x86_64 not found" >&2
                exit 1
            fi
            ;;
    esac

    source "$HOME/.config/lib/bash/sandbox/container-backend"
    source "$HOME/.config/lib/bash/sandbox/kvm-backend"
}

sandbox_name() {
    local name
    name="sandbox-$(basename "$PWD")"
    echo "${name//[^a-zA-Z0-9_-]/_}"
}

ensure_sandbox() {
    local name="$1"
    if ! backend_is_running "$name"; then
        echo "No sandbox running for current directory" >&2
        exit 1
    fi
}

setup_ssh_alias() {
    local name="$1" port="$2"
    if [[ -d "$SSH_CONFIG_DIR" ]]; then
        local config_file="$SSH_CONFIG_DIR/alias-$name.conf"
        (umask 0077; touch "$config_file")
        cat > "$config_file" <<EOF
        Host $name
            HostName localhost
            Port $port
            User dev
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
EOF
    fi
}

is_ssh_alias_setup() {
    local name="$1"
    local config_file="$SSH_CONFIG_DIR/alias-$name.conf"
    [[ -f "$config_file" ]]
}

get_ssh_agent_keys() {
    if command -v ssh-add >/dev/null 2>&1 && ssh-add -L >/dev/null 2>&1; then
        ssh-add -L | base64 -w0
        echo "Injecting SSH pub keys from agent" >&2
    else
        echo ""
    fi
}

get_ssh_port_or_fail() {
    local name="$1"
    local port
    port="$(backend_get_ssh_port "$name")"
    if [[ -z "$port" ]]; then
        echo "Error: Could not determine SSH port" >&2
        exit 1
    fi
    echo "$port"
}

backend_is_running() {
    local name="$1"
    case "$BACKEND" in
        container) is_container_running "$name" ;;
        kvm) is_kvm_running "$name" ;;
    esac
}

backend_get_ssh_port() {
    local name="$1"
    case "$BACKEND" in
        container) get_container_ssh_port "$name" ;;
        kvm) get_kvm_ssh_port "$name" ;;
    esac
}

backend_start() {
    local name="$1"
    case "$BACKEND" in
        container) start_container_sandbox "$name" ;;
        kvm) start_kvm_sandbox "$name" ;;
    esac
}

backend_stop() {
    local name="$1"
    case "$BACKEND" in
        container) stop_container_sandbox "$name" ;;
        kvm) stop_kvm_sandbox "$name" ;;
    esac
}

backend_enter() {
    local name="$1"
    case "$BACKEND" in
        container)
            exec $CONTAINER_ENGINE exec -it -e "TERM=${TERM:-xterm-256color}" -u dev -w /home/dev/workspace "$name" zsh
            ;;
        kvm)
            local port
            port="$(get_kvm_ssh_port "$name")"
            if [[ -z "$port" ]]; then
                echo "Error: Could not determine SSH port" >&2
                exit 1
            fi
            exec ssh -o UserKnownHostsFile=/dev/null \
                -o StrictHostKeyChecking=no \
                -p "$port" dev@localhost
            ;;
    esac
}

detect_running_backend() {
    local sandbox_name
    sandbox_name="$(sandbox_name)"

    local container_running=false
    local kvm_running=false

    if is_container_running "$sandbox_name"; then
        container_running=true
    fi

    if is_kvm_running "$sandbox_name"; then
        kvm_running=true
    fi

    if $container_running && $kvm_running; then
        echo "ERROR: Both backends running" >&2
        return 2
    elif $container_running; then
        echo "container"
        return 0
    elif $kvm_running; then
        echo "kvm"
        return 0
    else
        return 1
    fi
}

validate_no_backend_conflict() {
    local detected
    if detected=$(detect_running_backend); then
        if [[ "$detected" != "$BACKEND" ]]; then
            echo "Error: Already a running $detected sandbox" >&2
            exit 1
        fi
    fi
}

cmd_start_or_enter() {
    local name
    name="$(sandbox_name)"

    if [[ -n "${SANDBOX_CONTAINER:-}" ]]; then
        echo "Error: Already inside sandbox container" >&2
        exit 1
    fi

    if backend_is_running "$name"; then
        echo "Entering existing sandbox: $name ($BACKEND backend)"
    else
        validate_no_backend_conflict
        echo "Starting sandbox: $name ($BACKEND backend)"
        backend_start "$name"
    fi

    if [[ -n "$AI_BOOTSTRAP" ]]; then
        bootstrap_ai "$name" "$AI_BOOTSTRAP"
    fi

    backend_enter "$name"
}

cmd_list() {
    echo "Running sandboxes (container backend):"
    list_container_sandboxes

    echo ""
    echo "Running sandboxes (kvm backend):"
    list_kvm_sandboxes
}

cmd_stop() {
    local stop_all=false

    if [[ "${1:-}" == "-a" ]] || [[ "${1:-}" == "--all" ]]; then
        stop_all=true
    fi

    if $stop_all; then
        echo "Stopping all sandboxes (both backends)..."

        stop_all_container_sandboxes
        stop_all_kvm_sandboxes

        echo "Done"
    else
        local name
        name="$(sandbox_name)"

        echo "Stopping sandbox: $name"
        if backend_is_running "$name"; then
            backend_stop "$name"
        fi
        echo "Done"
    fi
}

cmd_info() {
    local name
    name="$(sandbox_name)"
    ensure_sandbox "$name"
    local port
    port="$(get_ssh_port_or_fail "$name")"

    echo "Sandbox: $name"
    echo "Backend: $BACKEND"
    echo "Workspace: $PWD"

    if is_ssh_alias_setup "$name"; then
        echo ""
        echo "You can connect using the SSH alias:"
        echo "  ssh $name"
    else
        echo ""
        echo "SSH connection:"
        echo "  ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -p $port dev@localhost"
        echo ""
        echo "JetBrains Gateway:"
        echo "  Host: localhost"
        echo "  Port: $port"
        echo "  User: dev"
    fi

    if [[ "$BACKEND" == "kvm" ]]; then
        echo ""
        echo "Connect to vm console (to exit: ctrl+] or ctrl+altgr + 9 on qwertz keyboard):"
        echo "  socat STDIO,raw,echo=0,escape=0x1d UNIX-CONNECT:$(kvm_console_socket "$name")"
    fi
}

open_url() {
    local url="$1"

    if command -v open >/dev/null 2>&1; then
        open "$url" >/dev/null
    else
        echo "Error: open command found" >&2
        echo "Please open this URL manually:" >&2
        echo "$url" >&2
        exit 1
    fi
}

cmd_idea() {
    local name
    name="$(sandbox_name)"
    ensure_sandbox "$name"
    local port
    port="$(get_ssh_port_or_fail "$name")"

    # https://www.jetbrains.com/help/toolbox-app/gettings-started-with-ssh.html
    if is_ssh_alias_setup "$name"; then
        local url="jetbrains://gateway/ssh/environment?h=$name&launchIde=true&ideHint=IU&projectHint=/home/dev/workspace"
    else
        local url="jetbrains://gateway/ssh/environment?h=localhost&u=dev&p=${port}&launchIde=true&ideHint=IU&projectHint=/home/dev/workspace"
    fi

    echo "Opening IntelliJ IDEA on $name..."

    open_url "$url"
}

cmd_code() {
    local name
    name="$(sandbox_name)"
    ensure_sandbox "$name"
    local port
    port="$(get_ssh_port_or_fail "$name")"

    # https://code.visualstudio.com/docs/remote/troubleshooting#_connect-to-a-remote-host-from-the-terminal
    if is_ssh_alias_setup "$name"; then
        local remote="ssh-remote+$name"
    else
        local remote="ssh-remote+dev@localhost:${port}/home/dev/workspace"
    fi
    # https://code.visualstudio.com/docs/configure/command-line#_opening-vs-code-with-urls
    local url="vscode://vscode-remote/$remote"

    echo "Opening Visual Studio Code on $name..."

    if command -v code >/dev/null 2>&1; then
        code --folder-uri "vscode-remote://$remote"
    else
        open_url "$url"
    fi
}

cmd_help() {
    cat <<EOF
sandbox - Containerized development sandbox

Usage:
    sandbox [--kvm|--container] <command>

Global Flags:
    --kvm           Use KVM backend
    --container     Use container backend
    --agent <name>  Bootstrap an AI agent in the sandbox with credentials from the host
                    Supported Agents: claude, gemini, opencode

Backend Selection:
    The backend is automatically detected based on running sandboxes.
    If no sandbox is running, defaults to container backend.
    Use --kvm or --container to explicitly select a backend.

Commands:
    (none)        Start/enter sandbox for current directory
    idea          Open IntelliJ IDEA connected to sandbox
    code          Open Visual Studio Code connected to sandbox
    list          List running sandboxes
    stop          Stop sandbox for current directory
    stop -a       Stop all sandboxes (both backends)
    info          Show SSH connection details
    help          Show this help

Examples:
    sandbox                   Start/enter (auto-detects backend)
    sandbox --kvm             Start KVM sandbox
    sandbox code              Open VS Code (auto-detects backend)
    sandbox info              Show info (auto-detects backend)
    sandbox stop -a           Stop all sandboxes

Current backend: $BACKEND
EOF
}

main() {
    local non_option_args=()
    local backend_explicitly_set=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --kvm)
                BACKEND="kvm"
                backend_explicitly_set=true
                shift
                ;;
            --container)
                BACKEND="container"
                backend_explicitly_set=true
                shift
                ;;
            --agent)
                local agent="${2:-}"
                if [[ -z "$agent" ]]; then
                    echo "--agent parameter is missing the value"
                    exit 1
                fi
                source "$HOME/.config/lib/bash/sandbox/ai-bootstrap"
                ensure_know_agent "$agent"
                AI_BOOTSTRAP="$agent"
                shift 2
                ;;
            *)
                non_option_args+=("$1")
                shift
                ;;
        esac
    done
    set -- "${non_option_args[@]}"

    validate_and_init_backend
    if ! $backend_explicitly_set; then
        local detected
        if detected=$(detect_running_backend); then
            BACKEND="$detected"
            validate_and_init_backend
        fi
    fi

    local cmd="${1:-}"

    case "$cmd" in
        ""|start|enter)  cmd_start_or_enter ;;
        idea)            cmd_idea ;;
        code)            cmd_code ;;
        ls|list)         cmd_list ;;
        stop)            shift; cmd_stop "$@" ;;
        info)            cmd_info ;;
        help|--help|-h)  cmd_help ;;
        *)
            echo "Error: Unknown command: $cmd" >&2
            echo "" >&2
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
