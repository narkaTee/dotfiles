#!/usr/bin/env bash
# Want to let the agent 'yolo' all day?
# put it in ai-jail and forget about it! ðŸ‘¯
#
# The "threat model" this is designed for is mainly "the agent nuked
# something I cannot easily restore".
#
# This does not properly protect against malicous agents/models, mcp, prompts etc!
# - https://blog.sshh.io/p/how-to-backdoor-large-language-models
#
# This does also break terminal resizing due to:
# - https://github.com/containers/bubblewrap/issues/573
# - https://github.com/containers/bubblewrap/pull/586

set -euo pipefail

if [ $# -lt 1 ]; then
    echo 'No tool to jail Â¯\_(ãƒ„)_/Â¯' >&2
    exit 1
fi

run_shell=false
if [ $# -gt 0 ] && [ "$1" = "--shell" ]; then
    run_shell=true
    shift
fi

if ! hash "$1" 2> /dev/null; then
    echo "No tool $1 found" >&2
    exit 1
fi

if ! hash bwrap 2> /dev/null; then
    echo "Could not find bubblewrap executeable (bwrap)" >&2
    exit 1
fi

tool="$1"
shift
tool_bin="$(command -v "$tool")"
tool_dir="$(dirname "$tool_bin")"
work_dir="$(pwd)"

declare -a bwrap_args=()

get_tool_config_dir() {
    case "$1" in
        "claude") echo ".claude" ;;
        "gemini") echo ".gemini" ;;
        "opencode") echo ".config/opencode" ;;
        *) return 1 ;;
    esac
}

add_global_npm_mounts() {
    local npm_global_modules
    if command -v npm >/dev/null 2>&1; then
        npm_global_modules="$(npm root -g 2>/dev/null || true)"
        if [ -n "$npm_global_modules" ] && [ -d "$npm_global_modules" ]; then
            bwrap_args+=(--ro-bind "$npm_global_modules" "$npm_global_modules")
        fi
    fi
}

add_git_mount() {
    if [ -d "$work_dir/.git" ]; then
        bwrap_args+=(--ro-bind "$work_dir/.git" "$work_dir/.git")
    fi
}

add_tool_mounts() {
    local tool_config_dir
    tool_config_dir="$(get_tool_config_dir "$1")" || {
        echo "Could not determine tool dir for $1" >&2
        exit 1
    }

    # Create overlay directories if they don't exist
    local overlay_dir="$HOME/$tool_config_dir-jail-overlay"
    local overlay_upper="$overlay_dir/upper-rw"
    local overlay_work="$overlay_dir/work"
    mkdir -p "$overlay_upper" "$overlay_work"

    # Use an overlay fs for the config dir.
    #  - original config as lower (ro) -> "overlay-src"
    #  - directory for changes filed: upper (rw) -> first arg to overlay
    #  - dir for the kernel: work dir
    bwrap_args+=(
        --overlay-src "$HOME/$tool_config_dir"
        --overlay "$overlay_upper" "$overlay_work" "$HOME/$tool_config_dir"
    )

    # tool-specific extras
    case "$1" in
        "claude")
            # Handle claude's single-file config which is not inside it's config dir...
            local file_overlay="$overlay_dir/.claude.json"
            if [ ! -f "$file_overlay" ] && [ -f "$HOME/.claude.json" ]; then
                cp "$HOME/.claude.json" "$file_overlay"
            fi
            bwrap_args+=(--bind "$file_overlay" "$HOME/.claude.json")
            ;;
    esac
}

bwrap_args=(
    --die-with-parent
    --unshare-all
    --share-net
    --new-session
    --clearenv
    --ro-bind /etc/passwd /etc/passwd
    --ro-bind /etc/group /etc/group
    --ro-bind /etc/hosts /etc/hosts
    --ro-bind /usr /usr
    --ro-bind /bin /bin
    --ro-bind /sbin /sbin
    --ro-bind /lib /lib
    --ro-bind /lib64 /lib64
    --proc /proc
    --tmpfs /proc/sys
    --tmpfs /proc/1
    --ro-bind /dev/null /proc/cmdline
    --ro-bind /etc/alternatives /etc/alternatives
    --ro-bind /etc/resolv.conf /etc/resolv.conf
    --ro-bind /etc/ssl/certs /etc/ssl/certs
    --dev /dev
    --tmpfs /home
    --bind "$work_dir" "$work_dir"
)

# conditional arguments
add_git_mount
bwrap_args+=(--ro-bind "$tool_dir" "$tool_dir")
add_tool_mounts "$tool"
add_global_npm_mounts

if [[ -d "/home/linuxbrew/.linuxbrew" ]]; then
    bwrap_args+=(--ro-bind "/home/linuxbrew/.linuxbrew" "/home/linuxbrew/.linuxbrew")
fi

declare -a additional_path_dirs=()
IFS=':' read -ra additional_path_dirs <<< "$PATH"
path_value="/usr/bin:/bin:$tool_dir"
for dir in "${additional_path_dirs[@]}"; do
    if [ -d "$dir" ]; then
        if [ ! -d "$dir" ]; then
            echo "Warning: PATH '$dir' does not exist, skipping" >&2
            continue
        fi
        path_value="$path_value:$dir"
        bwrap_args+=(--ro-bind "$dir" "$dir")
    fi
done

# environment
bwrap_args+=(
    --tmpfs /tmp
    --setenv HOME "$HOME"
    --setenv PATH "$path_value"
    --setenv USER "$(whoami)"
    --setenv EDITOR "$EDITOR"
    --setenv TERM "${TERM:-xterm-256color}"
    --cap-drop ALL
    --chdir "$work_dir"
    --
)

if [ $run_shell = true ]; then
    bwrap_args+=(bash)
else
    bwrap_args+=("$tool" "$@")
fi

bwrap "${bwrap_args[@]}"
