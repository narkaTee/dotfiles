#!/usr/bin/env bash
__tldr_cache="$HOME/.config/tldr/repos"
__tldr_cache_tldr="$__tldr_cache/tldr"
__tldr_cache_kb="$__tldr_cache/kb"
__tldr_pages="$__tldr_cache/pages"
# works for zsh and bash
# shellcheck disable=SC2296
__tldr_script="${BASH_SOURCE[0]:-${(%):-%x}}"

tldr_update_cache() {
    target="$1"
    repo="$2"
    if [ ! -d "$target" ]; then
        echo "tldr pages cache not found, updating..."
        mkdir -p "$target"
    fi

    if [ ! -d "$target/.git" ]; then
        git clone --depth=1 "$repo" "$target"
    fi

    if [ -f "$target/.git/FETCH_HEAD" ] &&  [ $((($(date '+%s') - $(stat -c %Y "$target/.git/FETCH_HEAD"))/60/60/24)) -gt 10 ]; then
        echo "tldr pages cache is older 10 days, updating..."
        (cd "$target" || exit
        git pull)
    fi
}

tldr_update_kb() {
    tldr_update_cache "$__tldr_cache_kb" "https://github.com/narkaTee/tldr-kb"
}

tldr_update_tldr() {
    tldr_update_cache "$__tldr_cache_tldr" "https://github.com/tldr-pages/tldr"
}

if [ ! -t 0 ]; then
    # stdin not connected to terminal, means we are beeing piped to
    cat | \
    sed "
        s/^# \(.*\)$/\x1b[1;33m\1\x1b[0m/;
        s/^> \(.*\)$/\x1b[3m\1\x1b[0m/;
        s/^- \(.*\)$/\x1b[3;37mâ€¢ \1\x1b[0m/;
        s/^\`\([^\`]*\)\`$/  \x1b[34m\1\x1b[0m/;
        "
fi

tldr() {
    tldr_update_kb
    tldr_update_tldr

    find "$__tldr_cache/"*/pages -name '*.md' \
        | sed "s#^$__tldr_cache/##" \
        | fzf \
            --scheme path --tiebreak=end,pathname,length \
            -q "$*" \
            --preview "cat '$__tldr_cache/{1}' | $__tldr_script" \
            --bind "enter:execute(cat $__tldr_cache/{1} | $__tldr_script | less -r)"
}

tldr "$@"
