# shellcheck shell=bash
# vim: ft=bash
# Want to let the agent 'yolo' all day?
# put it in ai-jail and forget about it! ðŸ‘¯
#
# The "threat model" this is designed for is mainly "the agent nuked
# something I cannot easily restore".
# For better isolation use a container/vm
#
# This does not properly protect against malicous agents/models, mcp, prompts etc
# when running "yolo" mode. An unsupervisied malicious agent could try to escape
# the sandbox by agressivly pen-testing it.
# - https://blog.sshh.io/p/how-to-backdoor-large-language-models

feature_bind_pwd
feature_bind_pwd_git_ro
feature_network
feature_bind_vim_cfg
feature_bind_npm_globals
feature_bind_all_path_dirs

get_tool_config_dir() {
    case "$1" in
        "claude") echo ".claude" ;;
        "gemini") echo ".gemini" ;;
        "opencode") echo ".config/opencode" ;;
        *)
            echo "[ai-jail profile] Could not determine tool dir for $1" >&2
            return 1
            ;;
    esac
}

if [ "$1" ]; then
    bind_ro_if_exists "$HOME/.local/share/claude/"
fi

# defined by boxed
# shellcheck disable=SC2154
tool_name="$command_name"
tool_config_dir="$(get_tool_config_dir "$tool_name")"
feature_run_optpl_with_template "$tool_name"

if [ -n "$tool_config_dir" ]; then
    # Use an overlay fs for the config dir.
    #  - original config as lower (ro) -> "overlay-src"
    #  - directory for changes: upper (rw) -> first arg to overlay
    #  - dir for the kernel/fuse: work dir
    # The overlay is scoped per project. If multiple instances are opened
    # with the same overlay folders instances may fail to write to the folders.
    overlay_base="$HOME/${tool_config_dir}-jail-overlay-$(basename "$PWD")"
    overlay_upper="$overlay_base/upper-rw"
    overlay_work="$overlay_base/work"

    # The overlay_mount does expand ~
    # shellcheck disable=SC2088
    overlay_mount "~/$tool_config_dir" "$overlay_upper" "$overlay_work" "~/$tool_config_dir"

    # tool-specific extras
    case "$tool_name" in
        "claude")
            # Handle claude's single-file config which is not inside it's config dir...
            file_overlay="$overlay_base/.claude.json"
            if [ ! -f "$file_overlay" ] && [ -f "$HOME/.claude.json" ]; then
                cp "$HOME/.claude.json" "$file_overlay"
            fi
            args+=(--bind "$file_overlay" "$HOME/.claude.json")
            ;;
    esac

    source "$HOME/.config/lib/bash/prompt-patcher/lib.bash"

    prompt_filename="$(get_prompt_filename "$tool_name")"
    overlay_prompt_file="$overlay_upper/$prompt_filename"

    # Initialize file if needed - copy from lower if exists
    if [[ ! -f "$overlay_prompt_file" ]]; then
        lower_prompt_file="$HOME/$tool_config_dir/$prompt_filename"
        if [[ -f "$lower_prompt_file" ]]; then
            cp "$lower_prompt_file" "$overlay_prompt_file"
        else
            touch "$overlay_prompt_file"
        fi
    fi

    # Patch with blocks (removes obsolete blocks automatically)
    replace_all_prompt_blocks "$overlay_prompt_file" "" "sandbox-bwrap" "git-readonly"
fi

add_env 'EDITOR'
