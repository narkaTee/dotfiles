# shellcheck shell=bash
# vim: ft=bash
# Want to let the agent 'yolo' all day?
# put it in ai-jail and forget about it! ðŸ‘¯
#
# The "threat model" this is designed for is mainly "the agent nuked
# something I cannot easily restore".
# For better isolation use a container/vm
#
# This does not properly protect against malicous agents/models, mcp, prompts etc
# when running "yolo" mode. An unsupervisied malicious agent could try to escape
# the sandbox by agressivly pen-testing it.
# - https://blog.sshh.io/p/how-to-backdoor-large-language-models

feature_bind_pwd
feature_bind_pwd_git_ro
feature_network
feature_bind_vim_cfg
feature_bind_npm_globals
feature_bind_all_path_dirs

get_tool_config_dir() {
    case "$1" in
        "claude") echo ".claude" ;;
        "gemini") echo ".gemini" ;;
        "opencode") echo ".config/opencode" ;;
        "codex") echo ".codex" ;;
        "pi") echo ".pi/agent" ;;
        *)
            echo "[ai-jail profile] Could not determine tool dir for $1" >&2
            return 1
            ;;
    esac
}

if [ "$1" ]; then
    bind_ro_if_exists "$HOME/.local/share/claude/"
fi

# defined by boxed
# shellcheck disable=SC2154
tool_name="$command_name"
tool_config_dir="$(get_tool_config_dir "$tool_name")"

cred_tmpdir=""
profile=""

if ! hash cfg 2>/dev/null; then
    echo "[ai-jail] cfg not found, continuing in overlay-only mode (no credentials)" >&2
elif cfg --has-profiles "$tool_name" 2>/dev/null; then
    profile=$(cfg --select "$tool_name" 2>/dev/null) || {
        echo "[ai-jail] Profile selection cancelled, aborting" >&2
        exit 1
    }

    cred_tmpdir=$(mktemp -d "${XDG_RUNTIME_DIR:-/tmp}/boxed-creds.XXXXXX")
    # shellcheck disable=SC2064
    trap "rm -rf '$cred_tmpdir'" EXIT

    cfg "$profile" --export-file --base-dir "$cred_tmpdir/" || {
        echo "[ai-jail] Failed to export credentials from profile '$profile'" >&2
        exit 1
    }

    while IFS= read -r line; do
        if [[ "$line" =~ ^export\ ([^=]+)=\'(.*)\'$ ]]; then
            args+=(--setenv "${BASH_REMATCH[1]}" "${BASH_REMATCH[2]}")
        fi
    done < <(cfg "$profile" --export-env 2>/dev/null || true)
else
    echo "[ai-jail] No cfg profiles found for '$tool_name', continuing in overlay-only mode" >&2
fi

if [ -n "$tool_config_dir" ]; then
    project_name=$(basename "$PWD")
    boxed_config_dir="$HOME/.boxed-${project_name}/${tool_config_dir}"

    mkdir -p "$boxed_config_dir"
    args+=(--bind "$boxed_config_dir" "$HOME/$tool_config_dir")

    # Bind credential files to tmpfs (writable, ephemeral)
    # Always bind credential paths (even if empty) to prevent writes to persistent storage
    if [ -z "$cred_tmpdir" ]; then
        cred_tmpdir=$(mktemp -d "${XDG_RUNTIME_DIR:-/tmp}/boxed-creds.XXXXXX")
        # shellcheck disable=SC2064
        trap "rm -rf '$cred_tmpdir'" EXIT
    fi

    case "$tool_name" in
        "claude")
            mkdir -p "$cred_tmpdir/.claude"
            touch "$cred_tmpdir/.claude/settings.json"

            claude_json="$cred_tmpdir/.claude.json"
            if [ ! -f "$claude_json" ] || ! jq -e '.hasCompletedOnboarding == true' "$claude_json" >/dev/null 2>&1; then
                if [ -f "$claude_json" ]; then
                    jq '. + {hasCompletedOnboarding: true, theme: "dark"}' "$claude_json" > "${claude_json}.tmp" && mv "${claude_json}.tmp" "$claude_json"
                else
                    echo '{"hasCompletedOnboarding": true, "theme": "dark"}' > "$claude_json"
                fi
            fi

            args+=(--bind "$cred_tmpdir/.claude/settings.json" "$HOME/.claude/settings.json")
            args+=(--bind "$claude_json" "$HOME/.claude.json")
            ;;
        "gemini")
            mkdir -p "$cred_tmpdir/.gemini"
            touch "$cred_tmpdir/.gemini/oauth_creds.json"
            args+=(--bind "$cred_tmpdir/.gemini/oauth_creds.json" "$HOME/.gemini/oauth_creds.json")
            ;;
        "opencode")
            mkdir -p "$cred_tmpdir/.config/opencode"
            touch "$cred_tmpdir/.config/opencode/opencode.jsonc"
            args+=(--bind "$cred_tmpdir/.config/opencode/opencode.jsonc" "$HOME/.config/opencode/opencode.jsonc")
            ;;
        "codex")
            mkdir -p "$cred_tmpdir/.codex"
            touch "$cred_tmpdir/.codex/config.toml"
            args+=(--bind "$cred_tmpdir/.codex/config.toml" "$HOME/.codex/config.toml")
            ;;
        "pi")
            ;;
    esac

    source "$HOME/.config/lib/bash/prompt-patcher/lib.bash"

    prompt_filename="$(get_prompt_filename "$tool_name")"
    boxed_prompt_file="$boxed_config_dir/$prompt_filename"

    if [[ ! -f "$boxed_prompt_file" ]]; then
        touch "$boxed_prompt_file"
    fi

    replace_all_prompt_blocks "$boxed_prompt_file" "" "sandbox-bwrap" "git-readonly"
fi

add_env 'EDITOR'
